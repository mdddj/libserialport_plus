name: Build eLinux

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-elinux:
    runs-on: ${{ github.server_url == 'https://github.com' && 'ubuntu-22.04' || 'kky' }}
    
    strategy:
      matrix:
        # arm64 requires cross-compilation toolchain, only build x64 for now
        target: [x64]
        backend: [wayland, x11]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev \
            curl git unzip xz-utils zip

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ github.server_url == 'https://github.com' && 'stable' || 'master' }}
          flutter-version: ${{ github.server_url == 'https://github.com' && '' || '3.24.0' }}
          git-source: ${{ github.server_url == 'https://github.com' && 'https://github.com/flutter/flutter.git' || 'https://ghproxy.com/https://github.com/flutter/flutter' }}

      - name: Clone flutter-elinux
        run: |
          git clone ${{ github.server_url == 'https://github.com' && 'https://github.com/sony/flutter-elinux.git' || 'https://ghproxy.com/https://github.com/sony/flutter-elinux.git' }} ~/flutter-elinux
          echo "$HOME/flutter-elinux/bin" >> $GITHUB_PATH

      - name: Setup flutter-elinux
        run: |
          flutter-elinux doctor

      - name: Get dependencies
        run: |
          cd example
          flutter pub get

      - name: Build eLinux (${{ matrix.target }} - ${{ matrix.backend }})
        run: |
          cd example
          flutter-elinux build elinux \
            --target-arch=${{ matrix.target }} \
            --target-backend-type=${{ matrix.backend }} \
            --release

      - name: Package artifact
        run: |
          cd example/build/elinux/${{ matrix.target }}/release
          tar -czvf elinux-${{ matrix.target }}-${{ matrix.backend }}.tar.gz bundle/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: elinux-${{ matrix.target }}-${{ matrix.backend }}
          path: example/build/elinux/${{ matrix.target }}/release/elinux-${{ matrix.target }}-${{ matrix.backend }}.tar.gz
          retention-days: 7

  release:
    needs: build-elinux
    runs-on: ${{ github.server_url == 'https://github.com' && 'ubuntu-22.04' || 'kky' }}
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
